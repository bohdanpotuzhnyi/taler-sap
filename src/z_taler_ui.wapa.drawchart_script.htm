<!-- drawchart_script.htm -->                                                                                                                                                                                                                                  
<script>                                                                                                                                                                                                                                                       
document.addEventListener('DOMContentLoaded', () => {                                                                                                                                                                                                          
  // 1. Load orders JSON from hidden div                                                                                                                                                                                                                       
  const jsonDiv = document.getElementById('json-data-orders');                                                                                                                                                                                                 
  if (!jsonDiv) {                                                                                                                                                                                                                                              
    console.error('Cannot find #json-data-orders');                                                                                                                                                                                                            
    return;                                                                                                                                                                                                                                                    
  }                                                                                                                                                                                                                                                            
  const raw = JSON.parse(jsonDiv.textContent);                                                                                                                                                                                                                 
  const orders = raw.orders || {};                                                                                                                                                                                                                             
  console.log(orders);                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
  // 0. Show the chart container and give it an explicit size                                                                                                                                                                                                  
  const chartDiv = document.getElementById('chart');                                                                                                                                                                                                           
  if (!chartDiv) {                                                                                                                                                                                                                                             
    console.error('Cannot find #chart');                                                                                                                                                                                                                       
    return;                                                                                                                                                                                                                                                    
  }                                                                                                                                                                                                                                                            
  chartDiv.style.display = 'block';                                                                                                                                                                                                                            
  chartDiv.style.width   = '100%';                                                                                                                                                                                                                             
  chartDiv.style.height  = '350px';             // give it a definite height                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
  // 2. Hook up the days selector                                                                                                                                                                                                                              
  const daysSelect = document.getElementById('days-select');                                                                                                                                                                                                   
  if (!daysSelect) {                                                                                                                                                                                                                                           
    console.error('Cannot find #days-select');                                                                                                                                                                                                                 
    return;                                                                                                                                                                                                                                                    
  }                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
  // helper: parse YYYYMMDD → Date                                                                                                                                                                                                                             
  function parseDate(yyyymmdd) {                                                                                                                                                                                                                               
    const [_, Y, M, D] = yyyymmdd.match(/(\d{4})(\d{2})(\d{2})/);                                                                                                                                                                                              
    return new Date(+Y, +M - 1, +D);                                                                                                                                                                                                                           
  }                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
  // bucket all four metrics over the chosen window                                                                                                                                                                                                            
  function bucketData(data, windowDays) {                                                                                                                                                                                                                      
    const now = new Date();                                                                                                                                                                                                                                    
    const start = new Date(now);                                                                                                                                                                                                                               
    start.setDate(now.getDate() - windowDays + 1);                                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
    // build slots: daily for ≤30d, monthly otherwise                                                                                                                                                                                                          
    const slots = [];                                                                                                                                                                                                                                          
    if (windowDays <= 30) {                                                                                                                                                                                                                                    
      for (let d = new Date(start); d <= now; d.setDate(d.getDate() + 1)) {                                                                                                                                                                                    
        slots.push(new Date(d));                                                                                                                                                                                                                               
      }                                                                                                                                                                                                                                                        
    } else {                                                                                                                                                                                                                                                   
      let y = start.getFullYear(), m = start.getMonth();                                                                                                                                                                                                       
      const endY = now.getFullYear(), endM = now.getMonth();                                                                                                                                                                                                   
      while (y < endY || (y === endY && m <= endM)) {                                                                                                                                                                                                          
        slots.push({ year: y, month: m });                                                                                                                                                                                                                     
        m++;                                                                                                                                                                                                                                                   
        if (m > 11) { m = 0; y++; }                                                                                                                                                                                                                            
      }                                                                                                                                                                                                                                                        
    }                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
    // init buckets                                                                                                                                                                                                                                            
    const buckets = slots.map(s => {                                                                                                                                                                                                                           
      const label = windowDays <= 30                                                                                                                                                                                                                           
        ? `${('0'+s.getDate()).slice(-2)}.${('0'+(s.getMonth()+1)).slice(-2)}`                                                                                                                                                                                 
        : `${s.month+1}/${s.year}`;                                                                                                                                                                                                                            
      return {                                                                                                                                                                                                                                                 
        label,                                                                                                                                                                                                                                                 
        values: { created: 0, paid: 0, completed: 0, refund: 0 }                                                                                                                                                                                               
      };                                                                                                                                                                                                                                                       
    });                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
    // find which bucket a date belongs to                                                                                                                                                                                                                     
    function findIndex(d) {                                                                                                                                                                                                                                    
      if (windowDays <= 30) {                                                                                                                                                                                                                                  
        return Math.floor((d - start) / 864e5);                                                                                                                                                                                                                
      } else {                                                                                                                                                                                                                                                 
        return buckets.findIndex(b => {                                                                                                                                                                                                                        
          const [mm, yy] = b.label.split('/');                                                                                                                                                                                                                 
          return d.getFullYear() === +yy && d.getMonth() === (+mm - 1);                                                                                                                                                                                        
        });                                                                                                                                                                                                                                                    
      }                                                                                                                                                                                                                                                        
    }                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
    // accumulate                                                                                                                                                                                                                                              
    Object.entries(data).forEach(([ds, vals]) => {                                                                                                                                                                                                             
      const d = parseDate(ds);                                                                                                                                                                                                                                 
      if (d < start || d > now) return;                                                                                                                                                                                                                        
      const idx = findIndex(d);                                                                                                                                                                                                                                
      if (idx < 0) return;                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
      const c    = (vals.created || 0) + (vals.posted_processed || 0) + (vals.posted || 0);                                                                                                                                                                    
      const p    = vals.paid || 0;                                                                                                                                                                                                                             
      const comp = vals.completed || 0;                                                                                                                                                                                                                        
      const r    = (vals.refund || 0) + (vals.refunding || 0) + (vals.refunded || 0);                                                                                                                                                                          
                                                                                                                                                                                                                                                               
      buckets[idx].values.created   += c;                                                                                                                                                                                                                      
      buckets[idx].values.paid      += p;                                                                                                                                                                                                                      
      buckets[idx].values.completed += comp;                                                                                                                                                                                                                   
      buckets[idx].values.refund    += r;                                                                                                                                                                                                                      
    });                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
    return buckets;                                                                                                                                                                                                                                            
  }                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
  // draw a grouped‐bar chart of all four metrics                                                                                                                                                                                                              
  function drawGroupedBarChart(containerId, buckets) {                                                                                                                                                                                                         
    const metrics = ['created','paid','completed','refund'];                                                                                                                                                                                                   
    const colors = {                                                                                                                                                                                                                                           
      created:   '#6c757d',                                                                                                                                                                                                                                    
      paid:      '#28A745',                                                                                                                                                                                                                                    
      completed: '#20C997',                                                                                                                                                                                                                                    
      refund:    '#6F42C1'                                                                                                                                                                                                                                     
    };                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
    const container = document.getElementById(containerId);                                                                                                                                                                                                    
    container.innerHTML = '';                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
    // use offsetWidth/offsetHeight so we get real pixels                                                                                                                                                                                                      
    const cw = container.offsetWidth;                                                                                                                                                                                                                          
    let   ch = container.offsetHeight;                                                                                                                                                                                                                         
    if (ch === 0) {                                                                                                                                                                                                                                            
      ch = 350;                       // fallback if still zero                                                                                                                                                                                                
      container.style.height = '350px';                                                                                                                                                                                                                        
    }                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
    const canvas = document.createElement('canvas');                                                                                                                                                                                                           
    canvas.width  = cw;                                                                                                                                                                                                                                        
    canvas.height = ch;                                                                                                                                                                                                                                        
    // styling to match system                                                                                                                                                                                                                                 
    canvas.style.width           = '100%';                                                                                                                                                                                                                     
    canvas.style.height          = '100%';                                                                                                                                                                                                                     
    canvas.style.display         = 'block';                                                                                                                                                                                                                    
    canvas.style.backgroundColor = '#fff';                                                                                                                                                                                                                     
    canvas.style.border          = '1px solid #dcdcdc';                                                                                                                                                                                                        
    canvas.style.boxShadow       = '0 1px 3px rgba(0, 0, 0, 0.1)';                                                                                                                                                                                             
    canvas.style.fontFamily      = 'Arial, sans-serif';                                                                                                                                                                                                        
    container.appendChild(canvas);                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
    const ctx = canvas.getContext('2d');                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
    const margin = { top: 50, bottom: 50, left: 60, right: 20 };                                                                                                                                                                                               
    const width  = cw  - margin.left - margin.right;                                                                                                                                                                                                           
    const height = ch  - margin.top  - margin.bottom;                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
    // find max value                                                                                                                                                                                                                                          
    const maxVal = Math.max(                                                                                                                                                                                                                                   
      1,                                                                                                                                                                                                                                                       
      ...buckets.flatMap(b => metrics.map(m => b.values[m]))                                                                                                                                                                                                   
    );                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
    // spacing math                                                                                                                                                                                                                                            
    const groupCount = buckets.length;                                                                                                                                                                                                                         
    const groupWidth = width  / groupCount;                                                                                                                                                                                                                    
    const barCount   = metrics.length;                                                                                                                                                                                                                         
    const barWidth   = groupWidth * 0.12;                                                                                                                                                                                                                      
    const gapInner   = groupWidth * 0.04;                                                                                                                                                                                                                      
    const totalBars  = barCount * barWidth + (barCount - 1) * gapInner;                                                                                                                                                                                        
    const groupOffset= (groupWidth - totalBars) / 2;                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
    // draw bars                                                                                                                                                                                                                                               
    buckets.forEach((b, i) => {                                                                                                                                                                                                                                
      metrics.forEach((m, j) => {                                                                                                                                                                                                                              
        const v    = b.values[m];                                                                                                                                                                                                                              
        const barH = (v / maxVal) * height;                                                                                                                                                                                                                    
        const x    = margin.left                                                                                                                                                                                                                               
                   + i * groupWidth                                                                                                                                                                                                                            
                   + groupOffset                                                                                                                                                                                                                               
                   + j * (barWidth + gapInner);                                                                                                                                                                                                                
        const y    = margin.top + (height - barH);                                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
        // bar                                                                                                                                                                                                                                                 
        ctx.fillStyle = colors[m];                                                                                                                                                                                                                             
        ctx.fillRect(x, y, barWidth, barH);                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
        // value label                                                                                                                                                                                                                                         
        ctx.fillStyle = '#333';                                                                                                                                                                                                                                
        ctx.font = '11px Arial, sans-serif';                                                                                                                                                                                                                   
        ctx.textAlign = 'center';                                                                                                                                                                                                                              
        ctx.fillText(v, x + barWidth/2, y - 6);                                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
        // x‐axis label under middle bar                                                                                                                                                                                                                       
        if (j === Math.floor(barCount/2)) {                                                                                                                                                                                                                    
          ctx.fillText(                                                                                                                                                                                                                                        
            b.label,                                                                                                                                                                                                                                           
            margin.left + i*groupWidth + groupWidth/2,                                                                                                                                                                                                         
            margin.top + height + 20                                                                                                                                                                                                                           
          );                                                                                                                                                                                                                                                   
        }                                                                                                                                                                                                                                                      
      });                                                                                                                                                                                                                                                      
    });                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
    // axes                                                                                                                                                                                                                                                    
    ctx.strokeStyle = '#333';                                                                                                                                                                                                                                  
    ctx.beginPath();                                                                                                                                                                                                                                           
    ctx.moveTo(margin.left, margin.top);                                                                                                                                                                                                                       
    ctx.lineTo(margin.left, margin.top + height);                                                                                                                                                                                                              
    ctx.lineTo(margin.left + width, margin.top + height);                                                                                                                                                                                                      
    ctx.stroke();                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
    // legend                                                                                                                                                                                                                                                  
    metrics.forEach((m, j) => {                                                                                                                                                                                                                                
      const lx = margin.left + j * 100;                                                                                                                                                                                                                        
      const ly = 30;                                                                                                                                                                                                                                           
      ctx.fillStyle = colors[m];                                                                                                                                                                                                                               
      ctx.fillRect(lx, ly - 10, 14, 14);                                                                                                                                                                                                                       
      ctx.fillStyle = '#333';                                                                                                                                                                                                                                  
      ctx.font = '12px Arial, sans-serif';                                                                                                                                                                                                                     
      ctx.textAlign = 'start';                                                                                                                                                                                                                                 
      ctx.fillText(                                                                                                                                                                                                                                            
        m.charAt(0).toUpperCase() + m.slice(1),                                                                                                                                                                                                                
        lx + 20,                                                                                                                                                                                                                                               
        ly + 2                                                                                                                                                                                                                                                 
      );                                                                                                                                                                                                                                                       
    });                                                                                                                                                                                                                                                        
  }                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
  // redraw on selector change                                                                                                                                                                                                                                 
  function updateChart() {                                                                                                                                                                                                                                     
    const days    = parseInt(daysSelect.value, 10);                                                                                                                                                                                                            
    const buckets = bucketData(orders, days);                                                                                                                                                                                                                  
    drawGroupedBarChart('chart', buckets);                                                                                                                                                                                                                     
  }                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
  daysSelect.addEventListener('change', updateChart);                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
  // initial render                                                                                                                                                                                                                                            
  updateChart();                                                                                                                                                                                                                                               
});                                                                                                                                                                                                                                                            
</script>                                                                                                                                                                                                                                                      