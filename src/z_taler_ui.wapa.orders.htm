<%@ page language="abap" %>                                                                                                                                                                                                                                    
<%@ extension name="htmlb" prefix="htmlb" %>                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
<htmlb:content design="DESIGN2008">                                                                                                                                                                                                                            
  <htmlb:page title="Orders">                                                                                                                                                                                                                                  
    <htmlb:form>                                                                                                                                                                                                                                               
      <%@ include file="style_embed.htm" %>                                                                                                                                                                                                                    
      <div class="page-wrapper">                                                                                                                                                                                                                               
        <%@ include file="sidebar.htm" %>                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
        <div class="main">                                                                                                                                                                                                                                     
              <div class="orders">                                                                                                                                                                                                                             
                <htmlb:textView text="Here are your orders:" design="EMPHASIZED" />                                                                                                                                                                            
                <!-- e.g. a tableView of orders -->                                                                                                                                                                                                            
                <htmlb:tableView                                                                                                                                                                                                                               
                id               = "transactionTable"                                                                                                                                                                                                          
                headerText       = "Filtered Transactions"                                                                                                                                                                                                     
                table            = "<%= lt_filtered %>"                                                                                                                                                                                                        
                width            = "100%"                                                                                                                                                                                                                      
                fillUpEmptyRows  = "false"                                                                                                                                                                                                                     
                design           = "standard"                                                                                                                                                                                                                  
                visibleRowCount  = "25"                                                                                                                                                                                                                        
                footerVisible    = "true"                                                                                                                                                                                                                      
                selectionMode    = "NONE"                                                                                                                                                                                                                      
                columnHeaderVisible = "true"                                                                                                                                                                                                                   
                filter           = "server"                                                                                                                                                                                                                    
                emptyTableText   = "No transactions found.">                                                                                                                                                                                                   
                  <htmlb:tableViewColumn columnName="BILLING_DOC" title="Billing Doc" />                                                                                                                                                                       
                  <htmlb:tableViewColumn columnName="AMOUNT" title="Amount" />                                                                                                                                                                                 
                  <htmlb:tableViewColumn columnName="TAX_AMOUNT" title="Tax Amount" />                                                                                                                                                                         
                  <htmlb:tableViewColumn columnName="CURRENCY" title="Currency" />                                                                                                                                                                             
                  <htmlb:tableViewColumn columnName="STATE" title="Status" />                                                                                                                                                                                  
                  <htmlb:tableViewColumn                                                                                                                                                                                                                       
                      columnName   = "taler_state"                                                                                                                                                                                                             
                      title        = "TALER STATE"                                                                                                                                                                                                             
                  />                                                                                                                                                                                                                                           
                  <htmlb:tableViewColumn                                                                                                                                                                                                                       
                      columnName   = "taler_pay_uri"                                                                                                                                                                                                           
                      title        = "ORDER TALER URI"                                                                                                                                                                                                         
                  />                                                                                                                                                                                                                                           
                  <htmlb:tableViewColumn                                                                                                                                                                                                                       
                      columnName   = "taler_wt_id"                                                                                                                                                                                                             
                      title        = "TALER WIRE ID"                                                                                                                                                                                                           
                  />                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
              </htmlb:tableView>                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
          <!-- Overlay -->                                                                                                                                                                                                                                     
          <div id="urlPopupOverlay"                                                                                                                                                                                                                            
               style="display:none;                                                                                                                                                                                                                            
                      position:fixed;top:0;left:0;width:100%;height:100%;                                                                                                                                                                                      
                      background:rgba(0,0,0,0.5);z-index:999;"                                                                                                                                                                                                 
               onclick="closePopup()"></div>                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
          <!-- Popup -->                                                                                                                                                                                                                                       
          <div id="urlPopup"                                                                                                                                                                                                                                   
               style="display:none;                                                                                                                                                                                                                            
                      position:fixed;top:50%;left:50%;                                                                                                                                                                                                         
                      transform:translate(-50%,-50%);                                                                                                                                                                                                          
                      background:#fff;padding:1rem;                                                                                                                                                                                                            
                      border:1px solid #ccc;box-shadow:0 2px 10px rgba(0,0,0,0.2);                                                                                                                                                                             
                      z-index:1000;">                                                                                                                                                                                                                          
            <div style="display: flex; justify-content: space-between; align-items: start;">                                                                                                                                                                   
              <h3 style="margin-top: 0;">Taler Order Status Page</h3>                                                                                                                                                                                          
              <span onclick="closePopup()"                                                                                                                                                                                                                     
                 style="cursor:pointer;font-size:1.5rem;font-weight:bold; line-height:1;">&times;</span>                                                                                                                                                       
            </div>                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
            <iframe                                                                                                                                                                                                                                            
              id="urlPopupFrame"                                                                                                                                                                                                                               
              style="width:80vw; height:80vh; border:1px solid #ccc;"                                                                                                                                                                                          
              sandbox="allow-same-origin allow-scripts allow-forms allow-popups">                                                                                                                                                                              
            </iframe>                                                                                                                                                                                                                                          
          </div>                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
          <script>                                                                                                                                                                                                                                             
            // once the tableView has rendered...                                                                                                                                                                                                              
            document.addEventListener('DOMContentLoaded', function(){                                                                                                                                                                                          
              var regex = /\/orders\/.*\?token=/;                                                                                                                                                                                                              
              document.querySelectorAll('span.urTxtStd').forEach(function(span){                                                                                                                                                                               
                var url = span.textContent.trim();                                                                                                                                                                                                             
                if (regex.test(url)) {                                                                                                                                                                                                                         
                  // create the button                                                                                                                                                                                                                         
                  var btn = document.createElement('button');                                                                                                                                                                                                  
                  btn.type = 'button';                                                                                                                                                                                                                         
                  btn.textContent = 'Show URL';                                                                                                                                                                                                                
                  btn.style.cursor = 'pointer';                                                                                                                                                                                                                
                  btn.addEventListener('click', function(e){                                                                                                                                                                                                   
                    e.preventDefault();                                                                                                                                                                                                                        
                    e.stopPropagation();                                                                                                                                                                                                                       
                    openPopup(url);                                                                                                                                                                                                                            
                  });                                                                                                                                                                                                                                          
                  // swap it in                                                                                                                                                                                                                                
                  span.parentNode.replaceChild(btn, span);                                                                                                                                                                                                     
                }                                                                                                                                                                                                                                              
              });                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
              // mapping is just to confirm we only process known statuses                                                                                                                                                                                     
              const orderStatuses = new Set([                                                                                                                                                                                                                  
                "created","posted","posted_processed","paid","refund_fail","refunding","refunded","completed"                                                                                                                                                  
              ]);                                                                                                                                                                                                                                              
              const talerStatuses = new Set([                                                                                                                                                                                                                  
                "unpaid","paid","removed","settled","refunded"                                                                                                                                                                                                 
              ]);                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
              // locate our inner table                                                                                                                                                                                                                        
              const table = document.querySelector("#transactionTable-content table");                                                                                                                                                                         
              if (!table) return;                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
              // rows in the TBODY of that inner table                                                                                                                                                                                                         
              const rows = table.tBodies[0].rows;                                                                                                                                                                                                              
              for (let row of rows) {                                                                                                                                                                                                                          
                // cells: [0]=BillingDoc, [1]=Currency, [2,3]=Amount, [4]=Status, [5]=TALER STATE                                                                                                                                                              
                const statusCell = row.cells[4];                                                                                                                                                                                                               
                const talerCell  = row.cells[5];                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                // helper to wrap text in a span                                                                                                                                                                                                               
                function wrap(cell, baseClass, validSet) {                                                                                                                                                                                                     
                  const txt = cell.textContent.trim().toLowerCase();                                                                                                                                                                                           
                  if (validSet.has(txt)) {                                                                                                                                                                                                                     
                    const span = document.createElement("span");                                                                                                                                                                                               
                    span.classList.add(baseClass, `${baseClass.slice(0,-6)}-${txt}`);                                                                                                                                                                          
                    span.textContent = txt.replace(/_/g," ");                                                                                                                                                                                                  
                    cell.textContent = "";                                                                                                                                                                                                                     
                    cell.appendChild(span);                                                                                                                                                                                                                    
                  }                                                                                                                                                                                                                                            
                }                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                wrap(statusCell, "status-label", orderStatuses);                                                                                                                                                                                               
                wrap(talerCell,  "taler-label",  talerStatuses);                                                                                                                                                                                               
              }                                                                                                                                                                                                                                                
            });                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
            function openPopup(url) {                                                                                                                                                                                                                          
              // point the iframe at the URL                                                                                                                                                                                                                   
              const frame = document.getElementById('urlPopupFrame');                                                                                                                                                                                          
              frame.src = url;                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
              // show overlay + popup                                                                                                                                                                                                                          
              document.getElementById('urlPopup').style.display = 'block';                                                                                                                                                                                     
              document.getElementById('urlPopupOverlay').style.display = 'block';                                                                                                                                                                              
            }                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
            function closePopup() {                                                                                                                                                                                                                            
              document.getElementById('urlPopup').style.display = 'none';                                                                                                                                                                                      
              document.getElementById('urlPopupOverlay').style.display = 'none';                                                                                                                                                                               
            }                                                                                                                                                                                                                                                  
          </script>                                                                                                                                                                                                                                            
          </div>                                                                                                                                                                                                                                               
        </div>                                                                                                                                                                                                                                                 
      </div>                                                                                                                                                                                                                                                   
    </htmlb:form>                                                                                                                                                                                                                                              
  </htmlb:page>                                                                                                                                                                                                                                                
</htmlb:content>                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               