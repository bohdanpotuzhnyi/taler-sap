<%@ page language="abap" %>                                                                                                                                                                                                                                    
<%@ extension name="htmlb" prefix="htmlb" %>                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
<htmlb:content design="DESIGN2008">                                                                                                                                                                                                                            
  <htmlb:page title="Notifications">                                                                                                                                                                                                                           
    <htmlb:form>                                                                                                                                                                                                                                               
      <%@ include file="style_embed.htm" %>                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
      <div class="page-wrapper">                                                                                                                                                                                                                               
        <%@ include file="sidebar.htm" %>                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
        <div class="main">                                                                                                                                                                                                                                     
          <div class="notifications">                                                                                                                                                                                                                          
            <htmlb:textView text="Welcome to the Notifications!" design="EMPHASIZED" />                                                                                                                                                                        
            <!-- Additional dashboard widgets go here -->                                                                                                                                                                                                      
            <htmlb:tableView                                                                                                                                                                                                                                   
              id               = "transactionTable"                                                                                                                                                                                                            
              headerText       = "Filtered Transactions"                                                                                                                                                                                                       
              table            = "<%= lt_filtered %>"                                                                                                                                                                                                          
              width            = "100%"                                                                                                                                                                                                                        
              fillUpEmptyRows  = "true"                                                                                                                                                                                                                        
              visibleRowCount  = "25"                                                                                                                                                                                                                          
              footerVisible    = "true"                                                                                                                                                                                                                        
              selectionMode    = "NONE"                                                                                                                                                                                                                        
              columnHeaderVisible = "true"                                                                                                                                                                                                                     
              emptyTableText   = "No transactions found.">                                                                                                                                                                                                     
                <htmlb:tableViewColumn columnName="SYSTEM_PART" title="System part" />                                                                                                                                                                         
                <htmlb:tableViewColumn columnName="NOT_TYPE" title="Notification type" />                                                                                                                                                                      
                <htmlb:tableViewColumn columnName="short_message" title="Short info" />                                                                                                                                                                        
                <htmlb:tableViewColumn columnName="long_message" title="View more info" />                                                                                                                                                                     
           </htmlb:tableView>                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
           <!-- Overlay for JSON details -->                                                                                                                                                                                                                   
            <div id="infoPopupOverlay"                                                                                                                                                                                                                         
                 style="display:none;                                                                                                                                                                                                                          
                        position:fixed; top:0; left:0; width:100%; height:100%;                                                                                                                                                                                
                        background:rgba(0,0,0,0.5); z-index:999;"                                                                                                                                                                                              
                 onclick="closeInfoPopup()"></div>                                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
            <!-- Popup for JSON details -->                                                                                                                                                                                                                    
            <div id="infoPopup"                                                                                                                                                                                                                                
                 style="display:none;                                                                                                                                                                                                                          
                        position:fixed; top:50%; left:50%;                                                                                                                                                                                                     
                        transform:translate(-50%,-50%);                                                                                                                                                                                                        
                        background:#fff; padding:1rem;                                                                                                                                                                                                         
                        border:1px solid #ccc; box-shadow:0 2px 10px rgba(0,0,0,0.2);                                                                                                                                                                          
                        max-width:80vw; max-height:80vh; overflow:auto;                                                                                                                                                                                        
                        z-index:1000;">                                                                                                                                                                                                                        
              <div style="display:flex; justify-content:space-between; align-items:center;">                                                                                                                                                                   
                <h3 style="margin:0 0 1em;">Details</h3>                                                                                                                                                                                                       
                <span onclick="closeInfoPopup()"                                                                                                                                                                                                               
                      style="cursor:pointer; font-size:1.5rem; font-weight:bold; line-height:1;">&times;</span>                                                                                                                                                
              </div>                                                                                                                                                                                                                                           
              <div id="infoPopupContent"                                                                                                                                                                                                                       
                   style="font-family:monospace; white-space:pre-wrap;"></div>                                                                                                                                                                                 
            </div>                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
           <script>                                                                                                                                                                                                                                            
            document.addEventListener('DOMContentLoaded', function(){                                                                                                                                                                                          
              // Only process known notification types                                                                                                                                                                                                         
              const notifTypes = new Set(['info','warning','error']);                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
              // Find the inner HTMLB table                                                                                                                                                                                                                    
              const table = document.querySelector("#transactionTable-content table");                                                                                                                                                                         
              if (!table) return;                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
              // Iterate over each body row                                                                                                                                                                                                                    
              for (let row of table.tBodies[0].rows) {                                                                                                                                                                                                         
                // NOT_TYPE is in the 2nd column (index 1)                                                                                                                                                                                                     
                const cell = row.cells[1];                                                                                                                                                                                                                     
                const txt  = cell.textContent.trim().toLowerCase();                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                if (notifTypes.has(txt)) {                                                                                                                                                                                                                     
                  // Wrap in a <span> with our badge classes                                                                                                                                                                                                   
                  const span = document.createElement('span');                                                                                                                                                                                                 
                  span.classList.add('notification-label', `notification-${txt}`);                                                                                                                                                                             
                  span.textContent = txt;                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
                  cell.textContent = '';                                                                                                                                                                                                                       
                  cell.appendChild(span);                                                                                                                                                                                                                      
                }                                                                                                                                                                                                                                              
              }                                                                                                                                                                                                                                                
            });                                                                                                                                                                                                                                                
          document.addEventListener('DOMContentLoaded', function(){                                                                                                                                                                                            
              // locate our HTMLB table                                                                                                                                                                                                                        
              const table = document.querySelector("#transactionTable-content table");                                                                                                                                                                         
              if (!table) return;                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
              // for each row, turn the raw JSON cell into a button:                                                                                                                                                                                           
              for (let row of table.tBodies[0].rows) {                                                                                                                                                                                                         
                const jsonCell = row.cells[3];  // 4th column = long_message                                                                                                                                                                                   
                const raw = jsonCell.textContent.trim();                                                                                                                                                                                                       
                if (!raw.startsWith('{')) continue;                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                // create button                                                                                                                                                                                                                               
                const btn = document.createElement('button');                                                                                                                                                                                                  
                btn.type = 'button';                                                                                                                                                                                                                           
                btn.textContent = 'View details';                                                                                                                                                                                                              
                btn.style.cursor = 'pointer';                                                                                                                                                                                                                  
                btn.addEventListener('click', function(e){                                                                                                                                                                                                     
                  e.stopPropagation();                                                                                                                                                                                                                         
                  openInfoPopup(raw);                                                                                                                                                                                                                          
                });                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                // replace cell contents                                                                                                                                                                                                                       
                jsonCell.textContent = '';                                                                                                                                                                                                                     
                jsonCell.appendChild(btn);                                                                                                                                                                                                                     
              }                                                                                                                                                                                                                                                
            });                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
            function openInfoPopup(jsonText) {                                                                                                                                                                                                                 
              let parsed, pretty;                                                                                                                                                                                                                              
              try {                                                                                                                                                                                                                                            
                parsed = JSON.parse(jsonText);                                                                                                                                                                                                                 
                // pretty-print as key: value lines                                                                                                                                                                                                            
                pretty = Object.entries(parsed)                                                                                                                                                                                                                
                               .map(([k,v]) => `${k}: ${v}`)                                                                                                                                                                                                   
                               .join('\n');                                                                                                                                                                                                                    
              } catch (err) {                                                                                                                                                                                                                                  
                pretty = 'Invalid JSON:\n' + jsonText;                                                                                                                                                                                                         
              }                                                                                                                                                                                                                                                
              document.getElementById('infoPopupContent').textContent = pretty;                                                                                                                                                                                
              document.getElementById('infoPopup').style.display = 'block';                                                                                                                                                                                    
              document.getElementById('infoPopupOverlay').style.display = 'block';                                                                                                                                                                             
            }                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
            function closeInfoPopup() {                                                                                                                                                                                                                        
              document.getElementById('infoPopup').style.display = 'none';                                                                                                                                                                                     
              document.getElementById('infoPopupOverlay').style.display = 'none';                                                                                                                                                                              
            }                                                                                                                                                                                                                                                  
          </script>                                                                                                                                                                                                                                            
          </div>                                                                                                                                                                                                                                               
        </div>                                                                                                                                                                                                                                                 
      </div>                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
    </htmlb:form>                                                                                                                                                                                                                                              
  </htmlb:page>                                                                                                                                                                                                                                                
</htmlb:content>                                                                                                                                                                                                                                               