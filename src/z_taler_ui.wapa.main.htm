<%@ page language="abap" %>                                                                                                                                                                                                                                    
<%@ extension name="htmlb" prefix="htmlb" %>                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
<htmlb:content design="DESIGN2008">                                                                                                                                                                                                                            
  <htmlb:page title="Dashboard">                                                                                                                                                                                                                               
    <htmlb:form>                                                                                                                                                                                                                                               
      <%@ include file="style_embed.htm" %>                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
      <div class="page-wrapper">                                                                                                                                                                                                                               
        <%@ include file="sidebar.htm" %>                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
        <div class="main">                                                                                                                                                                                                                                     
          <htmlb:textView text="Taler Merchant: <%= lv_business_name %>" design="EMPHASIZED" />                                                                                                                                                                
          <!-- Sync Info -->                                                                                                                                                                                                                                   
          <div class="sync-row">                                                                                                                                                                                                                               
            <htmlb:textView text="<%= lv_formatted_ts %>" design="STANDARD" />                                                                                                                                                                                 
            <htmlb:button text="Sync now" onClick="onSyncNow" />                                                                                                                                                                                               
          </div>                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
          <div class="days-selector">                                                                                                                                                                                                                          
            <label for="days-select">Show statistics for:</label>                                                                                                                                                                                              
            <select id="days-select">                                                                                                                                                                                                                          
              <option value="7">Last 7 days</option>                                                                                                                                                                                                           
              <option value="30">Last 30 days</option>                                                                                                                                                                                                         
              <option value="90">Last 90 days</option>                                                                                                                                                                                                         
              <option value="365">Last 365 days</option>                                                                                                                                                                                                       
            </select>                                                                                                                                                                                                                                          
          </div>                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
          <!-- Metrics Grid -->                                                                                                                                                                                                                                
        <div class="card-grid">                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
          <!-- Orders -->                                                                                                                                                                                                                                      
          <div class="card">                                                                                                                                                                                                                                   
            <htmlb:textView text="Total Orders"/>                                                                                                                                                                                                              
             <htmlb:textView id="total_orders" text="..." design="EMPHASIZED" />                                                                                                                                                                               
          </div>                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
          <div class="card">                                                                                                                                                                                                                                   
            <htmlb:textView text="Created Orders"/>                                                                                                                                                                                                            
            <htmlb:textView id="created_orders" text="..." design="EMPHASIZED" />                                                                                                                                                                              
          </div>                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
          <div class="card">                                                                                                                                                                                                                                   
            <htmlb:textView text="Paid Orders"/>                                                                                                                                                                                                               
            <htmlb:textView id="paid_orders" text="..." design="EMPHASIZED" />                                                                                                                                                                                 
          </div>                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
          <div class="card">                                                                                                                                                                                                                                   
            <htmlb:textView text="Refunded Orders"/>                                                                                                                                                                                                           
            <htmlb:textView id="refund_orders" text="..." design="EMPHASIZED" />                                                                                                                                                                               
          </div>                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
          <div class="card">                                                                                                                                                                                                                                   
            <htmlb:textView text="Completed Orders"/>                                                                                                                                                                                                          
            <htmlb:textView id="completed_orders" text="..." design="EMPHASIZED" />                                                                                                                                                                            
          </div>                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
          <div class="card">                                                                                                                                                                                                                                   
            <htmlb:textView text="Units sold"/>                                                                                                                                                                                                                
            <htmlb:textView id="units_sold" text="... Pcs" design="EMPHASIZED" />                                                                                                                                                                              
          </div>                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
          <!-- Sales -->                                                                                                                                                                                                                                       
          <div class="card">                                                                                                                                                                                                                                   
            <htmlb:textView text="Sales amount"/>                                                                                                                                                                                                              
            <htmlb:textView id="gross_amount" text="... EUR" design="EMPHASIZED" />                                                                                                                                                                            
          </div>                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
          <div class="card">                                                                                                                                                                                                                                   
            <htmlb:textView text="Profit amount"/>                                                                                                                                                                                                             
            <htmlb:textView id="net_amount" text="... EUR" design="EMPHASIZED" />                                                                                                                                                                              
          </div>                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
          <div class="card">                                                                                                                                                                                                                                   
            <htmlb:textView text="Taxes amount"/>                                                                                                                                                                                                              
            <htmlb:textView id="taxes_amount" text="... EUR" design="EMPHASIZED" />                                                                                                                                                                            
          </div>                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
          <div id="chart" style="display: none;"></div>                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
          <div id="chart_tax" style="display: none;"></div>                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
        </div>                                                                                                                                                                                                                                                 
      </div>                                                                                                                                                                                                                                                   
      <div id="json-data-orders" style="display: none;"><%= lv_orders_json %></div>                                                                                                                                                                            
      <div id="json-data-tax" style="display: none;"><%= lv_tax_json %></div>                                                                                                                                                                                  
      <div id="json-data-net" style="display: none;"><%= lv_net_json %></div>                                                                                                                                                                                  
      <div id="json-data-units" style="display: none;"><%= lv_units_json %></div>                                                                                                                                                                              
                                                                                                                                                                                                                                                               
      <script>                                                                                                                                                                                                                                                 
        window.onload = function () {                                                                                                                                                                                                                          
          const dropdown = document.getElementById("days-select");                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
          // Parse orders JSON                                                                                                                                                                                                                                 
          const rawOrders = document.getElementById("json-data-orders").innerText;                                                                                                                                                                             
          let fullData = {};                                                                                                                                                                                                                                   
          try {                                                                                                                                                                                                                                                
            fullData = JSON.parse(rawOrders);                                                                                                                                                                                                                  
          } catch (e) {                                                                                                                                                                                                                                        
            console.error("Failed to parse orders JSON:", e.message);                                                                                                                                                                                          
            return;                                                                                                                                                                                                                                            
          }                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
          // Parse tax JSON                                                                                                                                                                                                                                    
          const rawTax = document.getElementById("json-data-tax").innerText;                                                                                                                                                                                   
          let taxData = {};                                                                                                                                                                                                                                    
          try {                                                                                                                                                                                                                                                
            const parsedTax = JSON.parse(rawTax);                                                                                                                                                                                                              
            taxData = parsedTax.tax_statistic || {};                                                                                                                                                                                                           
          } catch (e) {                                                                                                                                                                                                                                        
            console.error("Failed to parse tax JSON:", e.message);                                                                                                                                                                                             
          }                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
          // Parse net JSON                                                                                                                                                                                                                                    
          const rawNet = document.getElementById("json-data-net").innerText;                                                                                                                                                                                   
          let netData = {};                                                                                                                                                                                                                                    
          try {                                                                                                                                                                                                                                                
            const parsedNet = JSON.parse(rawNet);                                                                                                                                                                                                              
            netData = parsedNet.net_statistic || {};                                                                                                                                                                                                           
          } catch (e) {                                                                                                                                                                                                                                        
            console.error("Failed to parse net JSON:", e.message);                                                                                                                                                                                             
          }                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
          // Parse units JSON                                                                                                                                                                                                                                  
          const rawUnits = document.getElementById("json-data-units").innerText;                                                                                                                                                                               
          let unitsData = {};                                                                                                                                                                                                                                  
          try {                                                                                                                                                                                                                                                
            const parsedUnits = JSON.parse(rawUnits);                                                                                                                                                                                                          
            unitsData = parsedUnits.units_sold || {};                                                                                                                                                                                                          
          } catch (e) {                                                                                                                                                                                                                                        
            console.error("Failed to parse units JSON:", e.message);                                                                                                                                                                                           
          }                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
          // Attach event handler                                                                                                                                                                                                                              
          dropdown.addEventListener("change", function () {                                                                                                                                                                                                    
            const selectedDays = parseInt(this.value, 10);                                                                                                                                                                                                     
            const today = new Date();                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
            // Filter order data                                                                                                                                                                                                                               
            const orders = fullData.orders || {};                                                                                                                                                                                                              
            const filtered = {};                                                                                                                                                                                                                               
            for (const dateStr in orders) {                                                                                                                                                                                                                    
              const year = parseInt(dateStr.slice(0, 4));                                                                                                                                                                                                      
              const month = parseInt(dateStr.slice(4, 6)) - 1; // JS months = 0–11                                                                                                                                                                             
              const day = parseInt(dateStr.slice(6, 8));                                                                                                                                                                                                       
              const orderDate = new Date(year, month, day);                                                                                                                                                                                                    
              const diffDays = (today - orderDate) / (1000 * 60 * 60 * 24);                                                                                                                                                                                    
              if (diffDays <= selectedDays) {                                                                                                                                                                                                                  
                filtered[dateStr] = orders[dateStr];                                                                                                                                                                                                           
              }                                                                                                                                                                                                                                                
            }                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
            // Calculate order totals                                                                                                                                                                                                                          
            const totals = {                                                                                                                                                                                                                                   
              total_orders: 0,                                                                                                                                                                                                                                 
              created_orders: 0,                                                                                                                                                                                                                               
              paid_orders: 0,                                                                                                                                                                                                                                  
              refund_orders: 0,                                                                                                                                                                                                                                
              completed_orders: 0                                                                                                                                                                                                                              
            };                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            for (const date in filtered) {                                                                                                                                                                                                                     
              const statuses = filtered[date];                                                                                                                                                                                                                 
              for (const status in statuses) {                                                                                                                                                                                                                 
                totals.total_orders += statuses[status];                                                                                                                                                                                                       
                switch (status) {                                                                                                                                                                                                                              
                  case 'created':                                                                                                                                                                                                                              
                  case 'posted':                                                                                                                                                                                                                               
                  case 'posted_processed':                                                                                                                                                                                                                     
                    totals.created_orders += statuses[status];                                                                                                                                                                                                 
                    break;                                                                                                                                                                                                                                     
                  case 'paid':                                                                                                                                                                                                                                 
                    totals.paid_orders += statuses[status];                                                                                                                                                                                                    
                    break;                                                                                                                                                                                                                                     
                  case 'refunded':                                                                                                                                                                                                                             
                  case 'refunding':                                                                                                                                                                                                                            
                  case 'refund':                                                                                                                                                                                                                               
                    totals.refund_orders += statuses[status];                                                                                                                                                                                                  
                    break;                                                                                                                                                                                                                                     
                  case 'completed':                                                                                                                                                                                                                            
                    totals.completed_orders += statuses[status];                                                                                                                                                                                               
                    break;                                                                                                                                                                                                                                     
                }                                                                                                                                                                                                                                              
              }                                                                                                                                                                                                                                                
            }                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
            // Calculate tax total                                                                                                                                                                                                                             
            let taxTotal = 0;                                                                                                                                                                                                                                  
            for (const dateStr in taxData) {                                                                                                                                                                                                                   
              const year = parseInt(dateStr.slice(0, 4));                                                                                                                                                                                                      
              const month = parseInt(dateStr.slice(4, 6)) - 1;                                                                                                                                                                                                 
              const day = parseInt(dateStr.slice(6, 8));                                                                                                                                                                                                       
              const taxDate = new Date(year, month, day);                                                                                                                                                                                                      
              const diffDays = (today - taxDate) / (1000 * 60 * 60 * 24);                                                                                                                                                                                      
              if (diffDays <= selectedDays) {                                                                                                                                                                                                                  
                taxTotal += taxData[dateStr];                                                                                                                                                                                                                  
              }                                                                                                                                                                                                                                                
            }                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
            // Calculate net total                                                                                                                                                                                                                             
            let netTotal = 0;                                                                                                                                                                                                                                  
            for (const dateStr in netData) {                                                                                                                                                                                                                   
              const year = parseInt(dateStr.slice(0, 4));                                                                                                                                                                                                      
              const month = parseInt(dateStr.slice(4, 6)) - 1;                                                                                                                                                                                                 
              const day = parseInt(dateStr.slice(6, 8));                                                                                                                                                                                                       
              const netDate = new Date(year, month, day);                                                                                                                                                                                                      
              const diffDays = (today - netDate) / (1000 * 60 * 60 * 24);                                                                                                                                                                                      
              if (diffDays <= selectedDays) {                                                                                                                                                                                                                  
                netTotal += netData[dateStr];                                                                                                                                                                                                                  
              }                                                                                                                                                                                                                                                
            }                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
            // Compute gross = net + tax                                                                                                                                                                                                                       
            let grossTotal = netTotal + taxTotal;                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
            // Calculate units sold total                                                                                                                                                                                                                      
            let unitsTotal = 0;                                                                                                                                                                                                                                
            for (const dateStr in unitsData) {                                                                                                                                                                                                                 
              const year = parseInt(dateStr.slice(0, 4));                                                                                                                                                                                                      
              const month = parseInt(dateStr.slice(4, 6)) - 1;                                                                                                                                                                                                 
              const day = parseInt(dateStr.slice(6, 8));                                                                                                                                                                                                       
              const unitsDate = new Date(year, month, day);                                                                                                                                                                                                    
              const diffDays = (today - unitsDate) / (1000 * 60 * 60 * 24);                                                                                                                                                                                    
              if (diffDays <= selectedDays) {                                                                                                                                                                                                                  
                unitsTotal += unitsData[dateStr];                                                                                                                                                                                                              
              }                                                                                                                                                                                                                                                
            }                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
            // Update DOM for order stats                                                                                                                                                                                                                      
            for (const key in totals) {                                                                                                                                                                                                                        
              const el = document.getElementById(key);                                                                                                                                                                                                         
              if (el) el.innerText = totals[key];                                                                                                                                                                                                              
            }                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
            // Update tax DOM field                                                                                                                                                                                                                            
            const taxEl = document.getElementById("taxes_amount");                                                                                                                                                                                             
            if (taxEl) {                                                                                                                                                                                                                                       
              taxEl.innerText = taxTotal.toFixed(2) + " EUR";                                                                                                                                                                                                  
            }                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
            const netEl = document.getElementById("net_amount");                                                                                                                                                                                               
            if (netEl) {                                                                                                                                                                                                                                       
              netEl.innerText = netTotal.toFixed(2) + " EUR";                                                                                                                                                                                                  
            }                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
            const grossEl = document.getElementById("gross_amount");                                                                                                                                                                                           
            if (grossEl) {                                                                                                                                                                                                                                     
              grossEl.innerText = grossTotal.toFixed(2) + " EUR";                                                                                                                                                                                              
            }                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
            const unitsEl = document.getElementById("units_sold");                                                                                                                                                                                             
            if (unitsEl) {                                                                                                                                                                                                                                     
              unitsEl.innerText = unitsTotal + " Pcs";                                                                                                                                                                                                         
            }                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
            console.log("Updated totals:", totals, "Tax:", taxTotal.toFixed(2), "Net:", netTotal.toFixed(2));                                                                                                                                                  
          });                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
          // Trigger default                                                                                                                                                                                                                                   
          dropdown.dispatchEvent(new Event("change"));                                                                                                                                                                                                         
        };                                                                                                                                                                                                                                                     
      </script>                                                                                                                                                                                                                                                
      <%@ include file="drawchart_script.htm" %>                                                                                                                                                                                                               
      <%@ include file="drawchart_amounts_script.htm" %>                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
    </htmlb:form>                                                                                                                                                                                                                                              
  </htmlb:page>                                                                                                                                                                                                                                                
</htmlb:content>                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               