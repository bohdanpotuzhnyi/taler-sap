<script>                                                                                                                                                                                                                                                       
document.addEventListener('DOMContentLoaded', () => {                                                                                                                                                                                                          
  const netDiv     = document.getElementById('json-data-net');                                                                                                                                                                                                 
  const taxDiv     = document.getElementById('json-data-tax');                                                                                                                                                                                                 
  const chartDiv   = document.getElementById('chart_tax');                                                                                                                                                                                                     
  const daysSelect = document.getElementById('days-select');                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
  if (!netDiv || !taxDiv || !chartDiv || !daysSelect) {                                                                                                                                                                                                        
    console.error('Missing required DOM elements');                                                                                                                                                                                                            
    return;                                                                                                                                                                                                                                                    
  }                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
  const netData = JSON.parse(netDiv.textContent).net_statistic || {};                                                                                                                                                                                          
  const taxData = JSON.parse(taxDiv.textContent).tax_statistic || {};                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
  // 0. Show the chart container and give it an explicit size                                                                                                                                                                                                  
  chartDiv.style.display = 'block';                                                                                                                                                                                                                            
  chartDiv.style.width   = '100%';                                                                                                                                                                                                                             
  chartDiv.style.height  = '350px';                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
  // helper: parse YYYYMMDD → Date                                                                                                                                                                                                                             
  function parseDate(yyyymmdd) {                                                                                                                                                                                                                               
    const [_, Y, M, D] = yyyymmdd.match(/(\d{4})(\d{2})(\d{2})/);                                                                                                                                                                                              
    return new Date(+Y, +M - 1, +D);                                                                                                                                                                                                                           
  }                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
  // bucket both net & tax over the chosen window, including empty slots                                                                                                                                                                                       
  function bucketData(netData, taxData, windowDays) {                                                                                                                                                                                                          
    const now   = new Date();                                                                                                                                                                                                                                  
    const start = new Date(now);                                                                                                                                                                                                                               
    start.setDate(now.getDate() - windowDays + 1);                                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
    // build slots: daily for ≤30d, monthly otherwise                                                                                                                                                                                                          
    const slots = [];                                                                                                                                                                                                                                          
    if (windowDays <= 30) {                                                                                                                                                                                                                                    
      for (let d = new Date(start); d <= now; d.setDate(d.getDate() + 1)) {                                                                                                                                                                                    
        slots.push(new Date(d));                                                                                                                                                                                                                               
      }                                                                                                                                                                                                                                                        
    } else {                                                                                                                                                                                                                                                   
      let y = start.getFullYear(), m = start.getMonth();                                                                                                                                                                                                       
      const endY = now.getFullYear(), endM = now.getMonth();                                                                                                                                                                                                   
      while (y < endY || (y === endY && m <= endM)) {                                                                                                                                                                                                          
        slots.push({ year: y, month: m });                                                                                                                                                                                                                     
        m++;                                                                                                                                                                                                                                                   
        if (m > 11) { m = 0; y++; }                                                                                                                                                                                                                            
      }                                                                                                                                                                                                                                                        
    }                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
    // init buckets                                                                                                                                                                                                                                            
    const buckets = slots.map(s => {                                                                                                                                                                                                                           
      const label = windowDays <= 30                                                                                                                                                                                                                           
        ? `${('0'+s.getDate()).slice(-2)}.${('0'+(s.getMonth()+1)).slice(-2)}`                                                                                                                                                                                 
        : `${s.month+1}/${s.year}`;                                                                                                                                                                                                                            
      return {                                                                                                                                                                                                                                                 
        label,                                                                                                                                                                                                                                                 
        values: { net: 0, tax: 0, total: 0 }                                                                                                                                                                                                                   
      };                                                                                                                                                                                                                                                       
    });                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
    function findIndex(d) {                                                                                                                                                                                                                                    
      if (windowDays <= 30) {                                                                                                                                                                                                                                  
        return Math.floor((d - start) / 864e5);                                                                                                                                                                                                                
      } else {                                                                                                                                                                                                                                                 
        return buckets.findIndex(b => {                                                                                                                                                                                                                        
          const [mm, yy] = b.label.split('/');                                                                                                                                                                                                                 
          return d.getFullYear() === +yy && d.getMonth() === (+mm - 1);                                                                                                                                                                                        
        });                                                                                                                                                                                                                                                    
      }                                                                                                                                                                                                                                                        
    }                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
    // accumulate net                                                                                                                                                                                                                                          
    Object.entries(netData).forEach(([ds, amt]) => {                                                                                                                                                                                                           
      const d = parseDate(ds);                                                                                                                                                                                                                                 
      if (d < start || d > now) return;                                                                                                                                                                                                                        
      const idx = findIndex(d);                                                                                                                                                                                                                                
      if (idx < 0) return;                                                                                                                                                                                                                                     
      buckets[idx].values.net   += amt || 0;                                                                                                                                                                                                                   
      buckets[idx].values.total += amt || 0;                                                                                                                                                                                                                   
    });                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
    // accumulate tax                                                                                                                                                                                                                                          
    Object.entries(taxData).forEach(([ds, amt]) => {                                                                                                                                                                                                           
      const d = parseDate(ds);                                                                                                                                                                                                                                 
      if (d < start || d > now) return;                                                                                                                                                                                                                        
      const idx = findIndex(d);                                                                                                                                                                                                                                
      if (idx < 0) return;                                                                                                                                                                                                                                     
      buckets[idx].values.tax   += amt || 0;                                                                                                                                                                                                                   
      buckets[idx].values.total += amt || 0;                                                                                                                                                                                                                   
    });                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
    return buckets;                                                                                                                                                                                                                                            
  }                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
  // draw a grouped‐bar chart of net, tax & total with first‐script styling                                                                                                                                                                                    
  function drawGroupedBarChart(containerId, buckets) {                                                                                                                                                                                                         
    const metrics = ['net','tax','total'];                                                                                                                                                                                                                     
    const colors  = {                                                                                                                                                                                                                                          
      net:   '#17a2b8',                                                                                                                                                                                                                                        
      tax:   '#ffc107',                                                                                                                                                                                                                                        
      total: '#007bff'                                                                                                                                                                                                                                         
    };                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
    const container = document.getElementById(containerId);                                                                                                                                                                                                    
    container.innerHTML = '';                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
    const cw = container.offsetWidth;                                                                                                                                                                                                                          
    let   ch = container.offsetHeight;                                                                                                                                                                                                                         
    if (ch === 0) {                                                                                                                                                                                                                                            
      ch = 350;                                                                                                                                                                                                                                                
      container.style.height = '350px';                                                                                                                                                                                                                        
    }                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
    const canvas = document.createElement('canvas');                                                                                                                                                                                                           
    canvas.width  = cw;                                                                                                                                                                                                                                        
    canvas.height = ch;                                                                                                                                                                                                                                        
    canvas.style.width           = '100%';                                                                                                                                                                                                                     
    canvas.style.height          = '100%';                                                                                                                                                                                                                     
    canvas.style.display         = 'block';                                                                                                                                                                                                                    
    canvas.style.backgroundColor = '#fff';                                                                                                                                                                                                                     
    canvas.style.border          = '1px solid #dcdcdc';                                                                                                                                                                                                        
    canvas.style.boxShadow       = '0 1px 3px rgba(0, 0, 0, 0.1)';                                                                                                                                                                                             
    canvas.style.fontFamily      = 'Arial, sans-serif';                                                                                                                                                                                                        
    container.appendChild(canvas);                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
    const ctx = canvas.getContext('2d');                                                                                                                                                                                                                       
    const margin = { top: 50, bottom: 50, left: 60, right: 20 };                                                                                                                                                                                               
    const width  = cw  - margin.left - margin.right;                                                                                                                                                                                                           
    const height = ch  - margin.top  - margin.bottom;                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
    const maxVal = Math.max(                                                                                                                                                                                                                                   
      1,                                                                                                                                                                                                                                                       
      ...buckets.flatMap(b => metrics.map(m => b.values[m]))                                                                                                                                                                                                   
    );                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
    const groupCount = buckets.length;                                                                                                                                                                                                                         
    const groupWidth = width  / groupCount;                                                                                                                                                                                                                    
    const barCount   = metrics.length;                                                                                                                                                                                                                         
    const barWidth   = groupWidth * 0.12;                                                                                                                                                                                                                      
    const gapInner   = groupWidth * 0.04;                                                                                                                                                                                                                      
    const totalBars  = barCount * barWidth + (barCount - 1) * gapInner;                                                                                                                                                                                        
    const groupOffset= (groupWidth - totalBars) / 2;                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
    // bars                                                                                                                                                                                                                                                    
    buckets.forEach((b, i) => {                                                                                                                                                                                                                                
      metrics.forEach((m, j) => {                                                                                                                                                                                                                              
        const v    = b.values[m];                                                                                                                                                                                                                              
        const barH = (v / maxVal) * height;                                                                                                                                                                                                                    
        const x    = margin.left                                                                                                                                                                                                                               
                   + i * groupWidth                                                                                                                                                                                                                            
                   + groupOffset                                                                                                                                                                                                                               
                   + j * (barWidth + gapInner);                                                                                                                                                                                                                
        const y    = margin.top + (height - barH);                                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
        ctx.fillStyle = colors[m];                                                                                                                                                                                                                             
        ctx.fillRect(x, y, barWidth, barH);                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
        // value label                                                                                                                                                                                                                                         
        ctx.fillStyle = '#333';                                                                                                                                                                                                                                
        ctx.font = '11px Arial, sans-serif';                                                                                                                                                                                                                   
        ctx.textAlign = 'center';                                                                                                                                                                                                                              
        ctx.fillText(v.toFixed(2), x + barWidth/2, y - 6);                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        // x‐axis label under middle bar                                                                                                                                                                                                                       
        if (j === Math.floor(barCount/2)) {                                                                                                                                                                                                                    
          ctx.fillText(                                                                                                                                                                                                                                        
            b.label,                                                                                                                                                                                                                                           
            margin.left + i*groupWidth + groupWidth/2,                                                                                                                                                                                                         
            margin.top + height + 20                                                                                                                                                                                                                           
          );                                                                                                                                                                                                                                                   
        }                                                                                                                                                                                                                                                      
      });                                                                                                                                                                                                                                                      
    });                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
    // axes                                                                                                                                                                                                                                                    
    ctx.strokeStyle = '#333';                                                                                                                                                                                                                                  
    ctx.beginPath();                                                                                                                                                                                                                                           
    ctx.moveTo(margin.left, margin.top);                                                                                                                                                                                                                       
    ctx.lineTo(margin.left, margin.top + height);                                                                                                                                                                                                              
    ctx.lineTo(margin.left + width, margin.top + height);                                                                                                                                                                                                      
    ctx.stroke();                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
    // legend                                                                                                                                                                                                                                                  
    metrics.forEach((m, j) => {                                                                                                                                                                                                                                
      const lx = margin.left + j * 100;                                                                                                                                                                                                                        
      const ly = 30;                                                                                                                                                                                                                                           
      ctx.fillStyle = colors[m];                                                                                                                                                                                                                               
      ctx.fillRect(lx, ly - 10, 14, 14);                                                                                                                                                                                                                       
      ctx.fillStyle = '#333';                                                                                                                                                                                                                                  
      ctx.font = '12px Arial, sans-serif';                                                                                                                                                                                                                     
      ctx.textAlign = 'start';                                                                                                                                                                                                                                 
      ctx.fillText(                                                                                                                                                                                                                                            
        m.charAt(0).toUpperCase() + m.slice(1),                                                                                                                                                                                                                
        lx + 20,                                                                                                                                                                                                                                               
        ly + 2                                                                                                                                                                                                                                                 
      );                                                                                                                                                                                                                                                       
    });                                                                                                                                                                                                                                                        
  }                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
  function updateChart() {                                                                                                                                                                                                                                     
    const days    = parseInt(daysSelect.value, 10);                                                                                                                                                                                                            
    const buckets = bucketData(netData, taxData, days);                                                                                                                                                                                                        
    drawGroupedBarChart('chart_tax', buckets);                                                                                                                                                                                                                 
  }                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
  daysSelect.addEventListener('change', updateChart);                                                                                                                                                                                                          
  updateChart();                                                                                                                                                                                                                                               
});                                                                                                                                                                                                                                                            
</script>                                                                                                                                                                                                                                                      